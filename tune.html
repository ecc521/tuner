<p id="names"></p>
<p id="frequencies"></p>

<script src="scale.js"></script>

<script>
function getid(n){return document.getElementById(n)}

window.AudioContext = window.AudioContext || window.webkitAudioContext;
let ctx = new AudioContext()


;(async function() {
    stream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    source = ctx.createMediaStreamSource(stream);

    analyzer = ctx.createAnalyser()
    analyzer.maxDecibels = -1
    analyzer.minDecibels = -100
    analyzer.fftSize = 32768

    source.connect(analyzer)
    //analyzer.connect(ctx.destination)

    freq = new Float32Array(analyzer.frequencyBinCount)
    time = new Float32Array(analyzer.frequencyBinCount)

    calc()

    console.log(stream)
    console.log(source)


}())



function updatefrequency(pitches) {
    let top = pitches.slice(-1) //The number is the amount of loudest notes you want
    //Note: This may order them backwards. Make sure to check how it is sorted.
    //Not an issue when only one pitch chosen.


    for (let i=0;i<top.length;i++) {
        top[i] = top[i].freq
    }


    //Sometimes this picks up the note an octave higher as the first one, and the actual note second or third
    //Check the top 5 and pick a lower note that is a factor of 2 lower if possible

    /*let newtop = []
    for (let i=0;i<top.length;i++) {
        newtop.push(top[i]/top[0])
    }

    let replacements = []
    for (let i=0;i<newtop.length;i++) {
        if (newtop[i] > 0.47 && newtop[i] < 0.53) {
            replacements = [newtop[i]*top[0]]
        }
    }

    if (replacements.length === 0) {replacements[0] = top[0]}
    top = replacements*/



    getid("frequencies").innerHTML = "Loudest Frequencies: " + top

    let note = notefromfreq(top[0])
    let text = note.name + "<sub>" + note.octave + "</sub>" + " (" + Math.round(note.cents) + " cents)"
    getid("names").innerHTML = text
}




function calc() {
    analyzer.getFloatFrequencyData(freq)

    let scale = 24000/freq.length

    let values = []
    for (let i=0;i<freq.length;i++) {
        values.push({freq:i*scale, loud:freq[i]})
    }

    function volume(a,b) {
        if (a.loud > b.loud) {return 1}
        if (b.loud > a.loud) {return -1}
        return 0
    }

    values = values.sort(volume)
    //The highest indexes are the loudest sounds



    //Call functions with our generated values
    try {
        updatefrequency(values)
    }catch(e){console.error(e)}

    requestAnimationFrame(calc)
}


</script>
